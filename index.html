<html>
<head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
    <a-scene vr-mode-ui="enabled: true">
        <!-- Ground -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="50" color="#7BC8A4"></a-plane>
        
        <!-- Avatar -->
        <a-box id="player" position="0 1 0" color="blue" width="1" height="1" depth="1"></a-box>
        
        <!-- Start Screen -->
        <a-text id="startScreen" position="0 4 -5" align="center" color="white" 
                value="ENDLESS RUNNER VR\n\nPress ANY controller button to START!\nThen use trigger to jump"
                scale="1.5 1.5 1.5"></a-text>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="0 10 0" color="#ffffff"></a-light>
        
        <!-- VR Camera with controllers -->
        <a-entity id="cameraRig" position="0 5 10">
            <a-camera look-at="#player"></a-camera>
            <a-entity id="leftController" 
                      oculus-touch-controls="hand: left"
                      hand-controls="hand: left"></a-entity>
            <a-entity id="rightController" 
                      oculus-touch-controls="hand: right"
                      hand-controls="hand: right"></a-entity>
        </a-entity>
    </a-scene>

    <script>
        // Get elements
        const player = document.querySelector('#player');
        const startScreen = document.querySelector('#startScreen');
        const leftController = document.querySelector('#leftController');
        const rightController = document.querySelector('#rightController');
        
        // Game state variables
        let gameStarted = false;
        let gameRunning = false;
        let avatarMoving = false;
        let score = 0;
        let gameTime = 0;
        
        // Player variables
        let playerZ = 0;
        let playerY = 1;
        let isJumping = false;
        let jumpSpeed = 0;
        const jumpPower = 0.3;
        const gravity = 0.02;
        const moveSpeed = 0.05;
        
        // Obstacle system
        let obstacles = [];
        let obstacleSpawnTimer = 0;
        const obstacleSpawnRate = 120;

        // Start the game
        function startGame() {
            console.log("Game started!");
            gameStarted = true;
            gameRunning = true;
            avatarMoving = true;
            
            startScreen.setAttribute('visible', 'false');
            createScoreDisplay();
        }

        // Jump function
        function jump() {
            if (gameRunning && !isJumping) {
                console.log("Jumping!");
                isJumping = true;
                jumpSpeed = jumpPower;
            }
        }

        // Move player forward
        function movePlayer() {
            if (avatarMoving) {
                playerZ -= moveSpeed;
            }
        }

        // Update player movement
        function updatePlayer() {
            if (isJumping) {
                playerY += jumpSpeed;
                jumpSpeed -= gravity;
                
                if (playerY <= 1) {
                    playerY = 1;
                    isJumping = false;
                    jumpSpeed = 0;
                }
            }
            
            player.setAttribute('position', `0 ${playerY} ${playerZ}`);
        }

        // Create obstacle
        function createObstacle() {
            const obstacle = document.createElement('a-box');
            obstacle.setAttribute('position', `${Math.random() * 4 - 2} 1 -20`);
            obstacle.setAttribute('color', 'red');
            obstacle.setAttribute('width', '1');
            obstacle.setAttribute('height', '2');
            obstacle.setAttribute('depth', '1');
            
            document.querySelector('a-scene').appendChild(obstacle);
            obstacles.push({
                element: obstacle,
                z: -20
            });
        }

        // Move obstacles
        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                obstacle.z += 0.1;
                
                const currentPos = obstacle.element.getAttribute('position');
                obstacle.element.setAttribute('position', `${currentPos.x} 1 ${obstacle.z}`);
                
                if (obstacle.z > 5) {
                    obstacle.element.remove();
                    obstacles.splice(i, 1);
                }
            }
        }

        // Create score display
        function createScoreDisplay() {
            const scoreDisplay = document.createElement('a-text');
            scoreDisplay.setAttribute('id', 'scoreDisplay');
            scoreDisplay.setAttribute('position', '-8 8 -10');
            scoreDisplay.setAttribute('color', 'white');
            scoreDisplay.setAttribute('value', `Score: ${score}`);
            scoreDisplay.setAttribute('scale', '1.5 1.5 1.5');
            
            document.querySelector('a-scene').appendChild(scoreDisplay);
        }

        // Simple collision detection
        function checkCollisions() {
            for (let obstacle of obstacles) {
                const playerPos = player.getAttribute('position');
                const obstaclePos = obstacle.element.getAttribute('position');
                
                const distance = Math.sqrt(
                    Math.pow(playerPos.x - obstaclePos.x, 2) + 
                    Math.pow(playerPos.z - obstaclePos.z, 2)
                );
                
                if (distance < 1) {
                    // Simple restart
                    console.log("Hit obstacle! Restarting...");
                    setTimeout(() => {
                        location.reload(); // Simple page reload
                    }, 1000);
                    return true;
                }
            }
            return false;
        }

        // Setup ALL possible button events
        function setupControllerEvents(controller) {
            if (!controller) return;
            
            // Listen for ALL button events to start the game
            const startEvents = [
                'triggerdown', 'abuttondown', 'bbuttondown', 'xbuttondown', 'ybuttondown', 
                'gripdown', 'thumbstickdown', 'surfacedown'
            ];
            
            startEvents.forEach(eventType => {
                controller.addEventListener(eventType, () => {
                    console.log(`${eventType} detected on controller`);
                    if (!gameStarted) {
                        startGame();
                    } else if (gameRunning) {
                        jump();
                    }
                });
            });
        }

        // Main game loop
        function gameLoop() {
            movePlayer();
            updatePlayer();
            
            if (gameRunning) {
                obstacleSpawnTimer++;
                if (obstacleSpawnTimer >= obstacleSpawnRate) {
                    createObstacle();
                    obstacleSpawnTimer = 0;
                }
                
                updateObstacles();
                checkCollisions();
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Initialize when scene loads
        document.querySelector('a-scene').addEventListener('loaded', () => {
            console.log("Scene loaded, setting up controllers");
            
            // Setup events for both controllers
            setupControllerEvents(leftController);
            setupControllerEvents(rightController);
            
            // Start game loop
            gameLoop();
        });
    </script>
</body>
</html>
