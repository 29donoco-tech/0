<html>
<head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
    <a-scene vr-mode-ui="enabled: true" cursor="rayOrigin: mouse">
        <!-- Ground -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="50" color="#7BC8A4"></a-plane>
        
        <!-- Avatar -->
        <a-box id="player" position="0 1 0" color="blue" width="1" height="1" depth="1"></a-box>
        
        <!-- Start Screen -->
        <a-text id="startScreen" position="0 4 -5" align="center" color="white" 
                value="ENDLESS RUNNER VR\n\nGame starts automatically in VR!\nLook up to jump\nLook down to duck\nOr click to jump"
                scale="1.5 1.5 1.5"></a-text>
        
        <!-- Clickable invisible plane for cursor interaction -->
        <a-plane id="clickArea" position="0 3 -4" rotation="0 0 0" width="10" height="6" 
                 color="transparent" opacity="0" class="clickable"></a-plane>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="0 10 0" color="#ffffff"></a-light>
        
        <!-- VR Camera with cursor -->
        <a-entity id="cameraRig" position="0 5 10">
            <a-camera id="camera" look-at="#player" 
                      cursor="fuse: true; fuseTimeout: 1500"
                      raycaster="objects: .clickable">
                
                <!-- Cursor (crosshair) -->
                <a-cursor id="cursor" 
                          position="0 0 -1"
                          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                          material="color: white; shader: flat"
                          animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
                          animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1"
                          animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1">
                </a-cursor>
                
                <!-- VR Controllers (for VR mode) -->
                <a-entity id="leftController" 
                          oculus-touch-controls="hand: left"
                          laser-controls="color: red"
                          raycaster="objects: .clickable"></a-entity>
                <a-entity id="rightController" 
                          oculus-touch-controls="hand: right"
                          laser-controls="color: blue"
                          raycaster="objects: .clickable"></a-entity>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // Get elements
        const player = document.querySelector('#player');
        const startScreen = document.querySelector('#startScreen');
        const camera = document.querySelector('#camera');
        const cursor = document.querySelector('#cursor');
        const clickArea = document.querySelector('#clickArea');
        
        // Game state variables
        let gameStarted = false;
        let gameRunning = false;
        let avatarMoving = false;
        let startTimer = 0;
        let score = 0;
        
        // Player variables
        let playerZ = 0;
        let playerY = 1;
        let isJumping = false;
        let isDucking = false;
        let jumpSpeed = 0;
        const jumpPower = 0.3;
        const gravity = 0.02;
        const moveSpeed = 0.05;
        
        // Head tracking variables
        let lastCameraY = 0;
        let jumpCooldown = 0;
        let duckCooldown = 0;
        
        // Obstacle system
        let obstacles = [];
        let obstacleSpawnTimer = 0;
        const obstacleSpawnRate = 120;

        // Jump function
        function jump() {
            if (gameRunning && !isJumping && jumpCooldown <= 0) {
                console.log("Jumping!");
                isJumping = true;
                jumpSpeed = jumpPower;
                jumpCooldown = 30;
            }
        }

        // Auto-start the game after 3 seconds
        function autoStartGame() {
            startTimer++;
            
            // Show countdown
            const secondsLeft = Math.max(0, 3 - Math.floor(startTimer / 60));
            if (secondsLeft > 0) {
                startScreen.setAttribute('value', `ENDLESS RUNNER VR\n\nGame starts automatically!\nLook up to jump\nLook down to duck\nOr click/gaze to jump\n\nStarting in ${secondsLeft}...`);
            } else if (!gameStarted) {
                startGame();
            }
        }

        // Start the game
        function startGame() {
            console.log("Game auto-started!");
            gameStarted = true;
            gameRunning = true;
            avatarMoving = true;
            
            startScreen.setAttribute('visible', 'false');
            createScoreDisplay();
        }

        // Head tracking controls
        function updateHeadControls() {
            if (!gameRunning) return;
            
            const cameraPos = camera.getAttribute('rotation');
            const currentY = cameraPos.x; // X rotation is looking up/down
            
            // Jump when looking up (negative X rotation)
            if (currentY < -20 && !isJumping && jumpCooldown <= 0) {
                console.log("Head up - jumping!");
                jump();
            }
            
            // Duck when looking down (positive X rotation)
            if (currentY > 20 && duckCooldown <= 0) {
                console.log("Head down - ducking!");
                isDucking = true;
                duckCooldown = 30;
            } else if (currentY <= 10) {
                isDucking = false;
            }
            
            // Reduce cooldowns
            if (jumpCooldown > 0) jumpCooldown--;
            if (duckCooldown > 0) duckCooldown--;
            
            lastCameraY = currentY;
        }

        // Move player forward
        function movePlayer() {
            if (avatarMoving) {
                playerZ -= moveSpeed;
            }
        }

        // Update player movement
        function updatePlayer() {
            if (isJumping) {
                playerY += jumpSpeed;
                jumpSpeed -= gravity;
                
                if (playerY <= 1) {
                    playerY = 1;
                    isJumping = false;
                    jumpSpeed = 0;
                }
            }
            
            if (isDucking) {
                playerY = 0.5;
            } else if (!isJumping) {
                playerY = 1;
            }
            
            player.setAttribute('position', `0 ${playerY} ${playerZ}`);
        }

        // Create obstacle
        function createObstacle() {
            const obstacle = document.createElement('a-box');
            obstacle.setAttribute('position', `${Math.random() * 4 - 2} 1 -20`);
            obstacle.setAttribute('color', 'red');
            obstacle.setAttribute('width', '1');
            obstacle.setAttribute('height', '2');
            obstacle.setAttribute('depth', '1');
            
            document.querySelector('a-scene').appendChild(obstacle);
            obstacles.push({
                element: obstacle,
                z: -20
            });
        }

        // Move obstacles
        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                obstacle.z += 0.1;
                
                const currentPos = obstacle.element.getAttribute('position');
                obstacle.element.setAttribute('position', `${currentPos.x} 1 ${obstacle.z}`);
                
                if (obstacle.z > 5) {
                    obstacle.element.remove();
                    obstacles.splice(i, 1);
                    score += 10;
                    updateScoreDisplay();
                }
            }
        }

        // Create score display
        function createScoreDisplay() {
            const scoreDisplay = document.createElement('a-text');
            scoreDisplay.setAttribute('id', 'scoreDisplay');
            scoreDisplay.setAttribute('position', '-8 8 -10');
            scoreDisplay.setAttribute('color', 'white');
            scoreDisplay.setAttribute('value', `Score: ${score}`);
            scoreDisplay.setAttribute('scale', '1.5 1.5 1.5');
            
            document.querySelector('a-scene').appendChild(scoreDisplay);
        }

        // Update score display
        function updateScoreDisplay() {
            const scoreDisplay = document.querySelector('#scoreDisplay');
            if (scoreDisplay) {
                scoreDisplay.setAttribute('value', `Score: ${score}`);
            }
        }

        // Simple collision detection
        function checkCollisions() {
            for (let obstacle of obstacles) {
                const playerPos = player.getAttribute('position');
                const obstaclePos = obstacle.element.getAttribute('position');
                
                const distance = Math.sqrt(
                    Math.pow(playerPos.x - obstaclePos.x, 2) + 
                    Math.pow(playerPos.z - obstaclePos.z, 2)
                );
                
                const heightDiff = Math.abs(playerPos.y - obstaclePos.y);
                
                if (distance < 1 && heightDiff < 1) {
                    gameOver();
                    return true;
                }
            }
            return false;
        }

        // Game over
        function gameOver() {
            console.log("Game over! Restarting in 3 seconds...");
            gameRunning = false;
            avatarMoving = false;
            
            const gameOverScreen = document.createElement('a-text');
            gameOverScreen.setAttribute('position', '0 4 -5');
            gameOverScreen.setAttribute('align', 'center');
            gameOverScreen.setAttribute('color', 'red');
            gameOverScreen.setAttribute('value', `GAME OVER!\nScore: ${score}\nRestarting in 3 seconds...`);
            gameOverScreen.setAttribute('scale', '2 2 2');
            
            document.querySelector('a-scene').appendChild(gameOverScreen);
            
            // Auto-restart after 3 seconds
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        // Main game loop
        function gameLoop() {
            if (!gameStarted) {
                autoStartGame();
            } else {
                updateHeadControls();
                movePlayer();
                updatePlayer();
                
                if (gameRunning) {
                    obstacleSpawnTimer++;
                    if (obstacleSpawnTimer >= obstacleSpawnRate) {
                        createObstacle();
                        obstacleSpawnTimer = 0;
                    }
                    
                    updateObstacles();
                    checkCollisions();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Setup click/gaze events
        function setupClickEvents() {
            // Click area for jumping
            clickArea.addEventListener('click', () => {
                console.log("Click detected!");
                if (!gameStarted) {
                    startGame();
                } else {
                    jump();
                }
            });

            // Cursor events for visual feedback
            cursor.addEventListener('mouseenter', () => {
                cursor.setAttribute('material', 'color: yellow');
            });

            cursor.addEventListener('mouseleave', () => {
                cursor.setAttribute('material', 'color: white');
            });
        }

        // Initialize when scene loads
        document.querySelector('a-scene').addEventListener('loaded', () => {
            console.log("Scene loaded with cursor and camera");
            setupClickEvents();
            gameLoop();
        });
    </script>
</body>
</html>
